# Travis CI build configuration for MediaWiki
# <https://travis-ci.org/wikimedia/mediawiki-core>
#
# The Wikimedia Foundation uses a self-hosted Jenkins instance to run unit
# tests, but it tests code against the version of PHP that is deployed on
# Wikimedia's production cluster. This Travis CI configuration is designed to
# complement that setup by testing MediaWiki on travis
#
language: php

matrix:
  fast_finish: true
  include:
    - env: dbtype=mysql dbusers=travis
      php: 5.5
    - env: dbtype=postgres dbusers=postgres
      php: 5.5
    - env: dbtype=mysql dbusers=travis
      php: hhvm
    - env: dbtype=mysql dbusers=travis
      php: 7

services:
  - mysql

before_install:
  - sudo apt-get install -qq djvulibre-bin tidy
  - composer self-update --quiet --no-interaction


install:
  - if [ "$dbtype" = postgres ]; then sudo /etc/init.d/postgresql stop; fi
  - if [ "$dbtype" = postgres ]; then sleep 3; fi
  - if [ "$dbtype" = postgres ]; then sudo /etc/init.d/postgresql start; fi
  - if [ "$dbtype" = postgres ]; then sleep 3; fi
  - composer install --prefer-source --quiet --no-interaction
  - if [ "$dbtype" = postgres ]; then psql -c "CREATE DATABASE traviswiki;" -U postgres; fi
  - >
     php maintenance/install.php
     --pass nyan TravisWiki admin
     --dbtype "$dbtype"
     --dbname traviswiki
     --dbuser "$dbusers"
     --scriptpath "/w"

before_script:
  - echo '$wgShowExceptionDetails = true;' >> LocalSettings.php
  - echo '$wgShowSQLErrors = true;' >> LocalSettings.php
  - echo '$wgDebugDumpSql = false;' >> LocalSettings.php
  - echo '$wgShowDBErrorBacktrace = true;' >> LocalSettings.php
  - php maintenance/update.php --quick

script:
  - php -d zend.enable_gc=0 tests/phpunit/phpunit.php

notifications:
  email: false
  irc:
    channels:
      - "chat.freenode.net#mediawiki-core"
      - "chat.freenode.net#mediawiki-feed"
    on_success: change
    on_failure: change
    skip_join: true
