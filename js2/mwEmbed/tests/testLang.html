<html>
<head>
<title>Test Plural Conversions (should match php) </title>
<script type="text/javascript" src="../mv_embed.js"></script>
<style>
td{
	border:solid thin black;
}
</style>
<script type="text/javascript" >
var scriptLoaderURID = 't10';
//for just setting one or two to test at a time for debug
var langKeyDebug = ['fr'];

//shortLangKey is an array of at least one language from every group in cldrConverter.php
var langKeyGroups = ['en','az', 'da', 'pt', 'fr', 'lv', 'ga','hr','cy','mk','mt','pl','sl'];

//longlangKey is every language we have a much more verbose test
var langKeyAll = [
		//no plurals, there are no rules
		'az','fa','hu','ja','ko','my to','tr','vi','yo','zh',
		'bo','dz','id','jv ka','km','kn','ms','th',
		
		/*
		'zero' 	=> 0,
		'one'	=> 1,
		'two'	=> 2,
		//n mod 100 in 3..10
		'few'	=> array( 'mod' => 100, 'is'=>'3-10' ),
		//n mod 100 in 11..99
		'many'	=> array( 'mod' => 100, 'is'=>'11-99')
		*/
		'ar',
		
		/*
		'one' => 1
		*/		
		'da','de','el','en','eo','es','et','fi','fo','gl',
		'he','iw','it','nb','nl','nn','no','pt_PT','sv',
		'af','bg','bn','ca','eu','fur','fy','gu','ha',
		'is','ku','lb','ml','mr','nah','ne','om','or',
		'pa','pap','ps','so','sq','sw','ta','te','tk',
		'ur','zu','mn','gsw',
		
		/*
		'one'=> '0-1'
		*/
		'pt','am','bh','fil','tl','guw','hi','ln','mg','nso','ti','wa',
		
		/*
		'one' => array( 'is'=>'0-2', 'not' => 2)
		*/
		'fr',
		 
		/*
		'zero' => 0,
		//n mod 10 is 1 and n mod 100 is not 11
		'one'=>array(
				array( 'mod' => 10, 'is' => 1 ),
				//AND
				array( 'mod' => 100, 'not' => 11)
			)
		*/
		'lv',
		
		/*
		'one' => 1,
		'two' => 2
		*/
		'ga','se','sma','smi','smj','smn','sms',
		
		
		/*
		'one' => 1,
		//n is 0 OR n is not 1 AND n mod 100 in 1..19
		'few' => array(
					'or'=> array(
						array( 'is' => 0),								
						array(
							array( 'not' => 1),
							//and
							array( 'mod' => 100, 'is'=>'1-19')
						)
					)
				)
			*/
		'ro','mo',
		
		
		/*
		//n mod 10 is 1 and n mod 100 not in 11..19
		'one' => array(
					array( 'mod'=>10, 'is'=> 1 ),
					array( 'mod'=> 100, 'not'=> '11-19')
				),
		//n mod 10 in 2..9 and n mod 100 not in 11..19
		'few' => array(
					array( 'mod'=> 10, 'is'=> '2-9' ),
					array( 'mod'=> 100, 'not' => '11-19')
				),
		*/
		'lt',
		
		
		/*
		//n mod 10 is 1 and n mod 100 is not 11
		'one' => array(
			array( 'mod' => 10, 'is' => 1),
			array( 'mod' => 100, 'not' => 11)
		),
		//n mod 10 in 2..4 and n mod 100 not in 12..14
		'few' => array(
			array( 'mod' => 10, 'is' => '2-4'),
			array( 'mod' => 100, 'not' => '12-14')
		),
		//n mod 10 is 0 or n mod 10 in 5..9 or n mod 100 in 11..14
		'many' => array(
			'or'=>array(
				array( 'mod'=> 10, 'is' => 0),
				array( 'mod'=> 10, 'is' => '5-9'),
				array( 'mod'=> 100, 'is' => '11-14')
			)
		),
		*/
		'hr','ru','sr','uk','be','bs','sh',
		
		
		/*
		'one' => 1,
		'few' => array(
			//n mod 10 in 2..4
			array( 'mod' => 10, 'is' => '2-4'),
			//and n mod 100 not in 12..14
			array( 'mod' => 100, 'not'=> '12-14'),
			//and n mod 100 not in 22..24
			array( 'mod' => 100, 'in' => '22-24')
		)
		*/
		'pl', 
		
		/*
		'one' => array( 'mod'=>100, 'is' => 1 ),
		'two' => array( 'mod'=>100, 'is' => 2 ),
		'few' => array( 'mod'=>100, 'is' => '3-4')
		*/
		'sl', 

	
		/*
		'one' => 1,
		//n is 0 or n mod 100 in 2..10
		'few' => array(
			array( 'is' => 0 ),
			'or',
			array( 'mod' => 100, 'is' => '2-10')
		),
		//n mod 100 in 11..19
		'many' => array( 'mod'=>100, 'is' => '11-19')
		*/	
		'mt',
		
		/*
		'one' => array('mod' => 10, 'is' => '1')
		*/
		'mk', 
		
		/*
		'one' => 1,
		'two' => 2,
		//n is 8 or n is 11
		'many' => array(
			array( 'is' => 8 ),
			array( 'is' => 11 )
		)*/
		'cy'
];

js2AddOnloadHook( function(){
	//do mauall script loaders calls to test multiple languages:
	function doLangTable(langSet){		
		//build table output: 
		var msgTestSet = { 												
			'undelete_short': [ 0, 1, 2, 5, 21, 30 ],			
			//category-subcat-count' has two params:
			'category-subcat-count' : [ 
				[0,10], 
				[1,2], 
				[3,30] 
			]			
		};
					
		var passTest=0;
		var failTest=0;
		var testCount=0;	
		$j.each(langSet, function(na, langKey){					
			js_log('load language key: ' + langKey);			
			//do a manual call to the script-lodaer:
			js_log('do load: ' + '../../../mwScriptLoader.php?class=$mw.testLang&urid='+ scriptLoaderURID +'&uselang='+langKey );
			$j.getScript('../../../mwScriptLoader.php?class=$mw.testLang&urid='+ scriptLoaderURID +'&uselang='+langKey, function(){
				var o='';
				o+='<tr><td colspan="6" height="20" style="font-size:large"><b>Lang:' + langKey + '</b></td></tr>';		
				//now for each langage msg: 
				$j.each(msgTestSet, function(mKey, mTestSet){
					//output table names:
					o+='<tr>'+
							'<td>$1[,$2]</td>'+
							'<td width="14%">Msg key</td>'+
							'<td width="34%">Msg text</td>'+
							'<td width="24%">Msg Transform JS</td>'+
							'<td width="24%">Msg Transform Mw</td>'+
						'</tr>';
				
					//for each number value
					for(var i in mTestSet){
						var numVal = mTestSet[i];						
						var numKey = (typeof numVal== 'object')? numVal.join( '_' ).replace('/ /', '_') : numVal;
						var tkey = mKey + '_' + numKey + '_' + langKey; 											
						o+='<tr>'+
								'<td>' + numVal + '</td>' + 
								'<td>' + mKey + '</td>' + 
								'<td>' + $mw.lang.gMsgNoTrans( mKey ) + '</td>' + 
								'<td id="' + tkey + '_js">' + $mw.lang.gM( mKey, numVal ) + '</td>';
						//show mw col:						
						if( mKey.substr(0, 5) == 'test_' ){
							o+='<td> (test msg) </td>';
						}else{  
							o+='<td id="' + tkey + '">loading...</td>';					
							
							//get transform from mw (& compare and highlight)
							function doPopWmMsg(mKey, numVal, numKey){ 
								//set the local tkey:
								var tkey = mKey + '_' + numKey + '_' + langKey;
								testCount++;
								$j('#score_card').html('Running Tests <span id="perc_done">0</sapn>% done');	
								var msgparam = (typeof numVal== 'object')? numVal.join( '|' ) : numVal;		
								do_api_req({
									'data': {
										'action' : 'parse',
										'uselang' : 'fr',
										'text' : '{{int:' + mKey + '|' + msgparam + '}}'
									},
									'url' : '../../../api.php'					
								}, function( data ) {							
									var t = '#'+ tkey ; 								
									if(data.parse && data.parse.text && data.parse.text['*']){
										$j(t).html( data.parse.text['*'] );										
										var js_txt = $j.trim( $j(t + '_js').text().replace('\n', '') );
										var php_txt = $j.trim( $j(t + ' p').text())
										//just get the part in the <p> to compare with js version
										if( js_txt != php_txt ){
										var cat = $j.trim( $j(t + ' p').text() );
										var dog =  $j.trim( $j(t + '_js').text() );											
											if( cat == dog)
												alert('wtf');
											//debugger;									
											$j(t).css('color', 'red');
											failTest++;
										}else{
											$j(t).css('color', 'green');
											passTest++;
										}
										var perc = ( failTest + passTest ) / testCount
										if( perc != 1){
											$j('#perc_done').html( Math.round(perc*1000)/1000 + '%');
										}else{
											var failHtlm = (failTest == 0)?failTest: '<span style="color:red">'+ failTest+'</span>';
											$j('#score_card').html( 
												'Passed: <span style="color:green">' + passTest + '</span> Failed:' + failHtlm );
										}			
									}else{
										$t.html(' error ');
									}
								});
							};
							//pop off an anonymous function call
							doPopWmMsg(mKey, numVal, numKey);
						} 
						o+='</tr>';										
					}
					//output a spacer:
					o+='<tr><td colspan="6" height="20"> </td></tr>';			
				});
				//put the output into the page: 
				$j('#table_out').append( o );
			});
		});// each lang key
	}
	//by default run the "debug" set:
	doLangTable( langKeyDebug );
});

</script>
</head>
<body>
<h3>Test Javascript plural msg transformations</h3>
<div id="score_card" style="font-size:large"></div>
<table id="table_out"></table>


</body>
</html>
