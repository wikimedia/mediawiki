<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Api Proxy Test</title>
<script type="text/javascript" src="../mv_embed.js"></script>

<script type="text/javascript" >
//HARD coded local test: 
var remote_wiki_host = 'http://test.wikipedia.org';
var remote_script_path = '/w';

js2AddOnloadHook( function(){	
	$j('#hostName').text( remote_wiki_host );
	//run the api-proxy setup:
	$j.apiProxy(
		'client', 
		{
			'server_frame': remote_wiki_host +  remote_script_path + '/index.php/MediaWiki:ApiProxy',
			'client_frame_path'	: '/wiki_trunk/js2/mwEmbed/libMwApi/NestedCallbackIframe.html',
		},
		function(){
			//callback function here: 
			$j('#setupDone').show('slow');
			$j('#doHello').click( doHello ); 	
			$j('#doAppend').click(doAppend);	
		}
	);				
});
function doHello(){
	js_log('to a hello user');
	$j('#helloTarget').html( mv_get_loading_img() );
	//first get the user name:
	getUserName(function( user_name ){	
		$j('#helloTarget').hide().text( user_name  ).fadeIn('slow');
	});
	return false;
}
function getUserName( callback ){
	var rObj = {
		'action':'query',
		'meta':'userinfo'
	}
	//we use normal do_api_req with keywork 'proxy' for the url 
	$mw.proxy.doRequest( rObj,
		function( data ){
			//if we have no data proxy is not setup?					
			if(!data){
				$mw.proxy.proxyNotReadyDialog();
			}
			//now we get the data back for that domain
			if( !data.query || !data.query.userinfo ){
				js_log("Error no query.userinfo ");
				return false;
			}
			callback( data.query.userinfo.name );									
		}
	);
} 

//simple "hello from api proxy" append on talk page
function doAppend(){
	$j('#appendTarget').html( mv_get_loading_img() );
	//get user name
	getUserName(function(userName){
		var eTitle = 'User_talk:' + userName;
		//get a edit token
		get_mw_token(eTitle, 'proxy', function( token ){
			js_log("got token: " + token) ;
			var aReq = {
				'action':'edit',
				'title': eTitle,
				'summary': "Api proxy test edit",
				'appendtext': "\n\n==== Hello from Api proxy At: " + Date() + " ====",
				'token': token
			}
			do_api_req({
				'data': aReq,
				'url': 'proxy'
			},function(result){
				if(result.edit && result.edit.newrevid){				
					$j('#appendTarget').html( "success: " + JSON.stringify ( result) );
					url = remote_wiki_host +  remote_script_path + '/index.php/';
					url+= result.edit.title.replace(' ', '_');
					$j('#appendTarget').append( '<br><a target="_new" href="' + url + '">visit page</a>' );
				}else{
					$j('#appendTarget').html( "falied: " + JSON.stringify ( result) );
				}
			});
			
		});
	});
}
</script>
 
</head>
<body>
<h3> Simple API proxy testing system </h3>

<div id="setupProxy">Proxy for:  <span id="hostName"></span> <br><span style="font-size:small">( be sure to enable the mwEmbed gadget or add importScriptURI( 'path_to_local_mw_install' + /js2/remoteMwEmbed.js ) to your User skin .js page </span></div>
<div id="setupDone" style="display:none;">
	<br> <a href="#" id="doHello" >Hello User:</a> <span id="helloTarget"></span>
	<br><br><br> <a href="#" id="doAppend">Append Msg to Talk page:</a>
	<div id="appendTarget"></div>
</div>

</body>
</html>